name: ðŸš€ Release Pipeline

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20.x"
  FORCE_COLOR: 1

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # Job 1: Validate Release
  validate-release:
    name: ðŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          echo "Is pre-release: $IS_PRERELEASE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Validate package.json version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          RELEASE_VERSION="${{ steps.version.outputs.version }}"
          RELEASE_VERSION="${RELEASE_VERSION#v}"

          if [[ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]]; then
            echo "âŒ Version mismatch: package.json ($PACKAGE_VERSION) != tag ($RELEASE_VERSION)"
            exit 1
          else
            echo "âœ… Version validation passed: $PACKAGE_VERSION"
          fi

  # Job 2: Full Test Suite
  test-release:
    name: ðŸ§ª Full Test Suite
    runs-on: ubuntu-latest
    needs: validate-release
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run full test suite
        run: |
          npm run lint
          npm run test:api
          npx playwright test --project=${{ matrix.browser }}
          npm run bdd:smoke

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-test-results-${{ matrix.browser }}
          path: |
            playwright-report/
            test-results/
            reports/
          retention-days: 30

  # Job 3: Build Release Assets
  build-release:
    name: ðŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: [validate-release, test-release]
    outputs:
      artifact-name: ${{ steps.build.outputs.artifact-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build release package
        id: build
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"
          ARTIFACT_NAME="playwright-cucumber-${VERSION}"

          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

          # Create release directory
          mkdir -p release/$ARTIFACT_NAME

          # Copy source files
          cp -r src release/$ARTIFACT_NAME/
          cp -r .github release/$ARTIFACT_NAME/
          cp package*.json release/$ARTIFACT_NAME/
          cp playwright.config.ts release/$ARTIFACT_NAME/
          cp cucumber.config.js release/$ARTIFACT_NAME/
          cp tsconfig.json release/$ARTIFACT_NAME/
          cp README.md release/$ARTIFACT_NAME/
          cp lighthouserc.json release/$ARTIFACT_NAME/

          # Create installation script
          cat > release/$ARTIFACT_NAME/install.sh << 'EOF'
          #!/bin/bash
          echo "ðŸš€ Installing Playwright-Cucumber Framework..."
          npm install
          npx playwright install
          echo "âœ… Installation complete!"
          echo "Run 'npm test' to execute tests"
          EOF
          chmod +x release/$ARTIFACT_NAME/install.sh

          # Create release info
          cat > release/$ARTIFACT_NAME/RELEASE_INFO.md << EOF
          # Playwright-Cucumber Framework Release

          **Version:** $VERSION  
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Commit:** ${{ github.sha }}  

          ## Quick Start
          \`\`\`bash
          ./install.sh
          npm test
          \`\`\`

          ## What's Included
          - Complete test framework with Playwright + Cucumber
          - API testing capabilities
          - Visual regression testing
          - Accessibility testing with axe-core
          - BDD scenarios with Gherkin syntax
          - Performance monitoring
          - CI/CD workflows for GitHub Actions
          EOF

          # Create archives
          cd release
          tar -czf ${ARTIFACT_NAME}.tar.gz $ARTIFACT_NAME/
          zip -r ${ARTIFACT_NAME}.zip $ARTIFACT_NAME/

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            release/*.tar.gz
            release/*.zip
          retention-days: 90

  # Job 4: Generate Release Notes
  generate-release-notes:
    name: ðŸ“ Generate Release Notes
    runs-on: ubuntu-latest
    needs: validate-release
    outputs:
      release-notes: ${{ steps.notes.outputs.release-notes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.validate-release.outputs.version }}"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "# Release Notes for $VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "**Release Date:** $(date -u +"%Y-%m-%d")" >> release_notes.md
          echo "**Commit:** \`${{ github.sha }}\`" >> release_notes.md
          echo "" >> release_notes.md

          if [[ -n "$PREV_TAG" ]]; then
            echo "## Changes since $PREV_TAG" >> release_notes.md
            echo "" >> release_notes.md
            
            # Generate commit list
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release_notes.md
            echo "" >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "## Test Suite Coverage" >> release_notes.md
          echo "- âœ… E2E Tests (Chromium, Firefox, WebKit)" >> release_notes.md
          echo "- âœ… API Testing" >> release_notes.md
          echo "- âœ… Visual Regression Testing" >> release_notes.md
          echo "- âœ… Accessibility Testing (WCAG)" >> release_notes.md
          echo "- âœ… BDD Scenarios with Cucumber" >> release_notes.md
          echo "- âœ… Performance Monitoring" >> release_notes.md
          echo "- âœ… Security Scanning" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# Download and extract release" >> release_notes.md
          echo "tar -xzf playwright-cucumber-${VERSION}.tar.gz" >> release_notes.md
          echo "cd playwright-cucumber-${VERSION}" >> release_notes.md
          echo "./install.sh" >> release_notes.md
          echo "\`\`\`" >> release_notes.md

          # Store release notes for next step
          RELEASE_NOTES=$(cat release_notes.md)
          echo "release-notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Job 5: Create GitHub Release
  create-release:
    name: ðŸŽ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-release, build-release, generate-release-notes]
    steps:
      - name: Download release assets
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-release.outputs.version }}
          name: Release ${{ needs.validate-release.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release-notes }}
          prerelease: ${{ needs.validate-release.outputs.is-prerelease == 'true' }}
          files: |
            release-assets/*.tar.gz
            release-assets/*.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # Job 6: Deploy Documentation
  deploy-docs:
    name: ðŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: [create-release]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Generate documentation
        run: |
          mkdir -p docs
          cp README.md docs/index.md

          # Copy deployment guides
          if [ -f DEPLOYMENT_GUIDE.md ]; then
            cp DEPLOYMENT_GUIDE.md docs/
          fi

          if [ -f DEPLOYMENT_TUTORIAL.md ]; then
            cp DEPLOYMENT_TUTORIAL.md docs/
          fi

          # Create index.html
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Playwright-Cucumber Framework</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
              h1 { color: #2d5aa0; }
              .release-badge { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }
            </style>
          </head>
          <body>
            <h1>ðŸŽ­ Playwright-Cucumber Testing Framework</h1>
            <p><span class="release-badge">Latest Release: ${{ needs.validate-release.outputs.version }}</span></p>
            <h2>Quick Links</h2>
            <ul>
              <li><a href="https://github.com/${{ github.repository }}">GitHub Repository</a></li>
              <li><a href="https://github.com/${{ github.repository }}/releases">Releases</a></li>
              <li><a href="./index.md">Documentation</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 7: Notify Success
  notify-success:
    name: ðŸŽŠ Notify Success
    runs-on: ubuntu-latest
    needs: [create-release, deploy-docs]
    steps:
      - name: Success notification
        run: |
          echo "ðŸŽ‰ Release ${{ needs.validate-release.outputs.version }} completed successfully!"
          echo "ðŸ“¦ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate-release.outputs.version }}"
          echo "ðŸ“š Documentation: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

          # Here you can add integrations with Slack, Teams, Discord, etc.
          # Example:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸš€ New release published: ${{ needs.validate-release.outputs.version }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
