name: Fetch Secrets from Azure Key Vault

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  fetch-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Azure SDK
        run: npm install @azure/identity @azure/keyvault-secrets

      - name: Fetch Secrets from Azure Key Vault
        id: keyvault
        env:
          AZURE_KEYVAULT_URI: ${{ secrets.AZURE_KEYVAULT_URI }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          echo "üîê Fetching secrets from Key Vault..."
          node <<'EOF'
          const { ClientSecretCredential } = require('@azure/identity');
          const { SecretClient } = require('@azure/keyvault-secrets');

          const credential = new ClientSecretCredential(
            process.env.AZURE_TENANT_ID,
            process.env.AZURE_CLIENT_ID,
            process.env.AZURE_CLIENT_SECRET
          );

          const client = new SecretClient(process.env.AZURE_KEYVAULT_URI, credential);
          const names = ['ORANGEHRM_BASE_URL', 'ORANGEHRM_USERNAME', 'ORANGEHRM_PASSWORD'];

          const fetch = async () => {
            for (const name of names) {
              try {
                const secret = await client.getSecret(name);
                console.log(`‚úÖ Loaded ${name}`);
                console.log(`${name}=${secret.value}`);
              } catch (error) {
                console.log(`‚ùå Failed to load ${name}: ${error.message}`);
              }
            }
          };

          fetch().catch(console.error);
          EOF
