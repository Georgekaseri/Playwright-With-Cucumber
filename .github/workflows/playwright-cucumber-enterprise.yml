name: ğŸ”µ Playwright â€¢ Cucumber Enterprise CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ğŸ§ª UI Testing Suite
  ui-tests:
    name: ğŸ§ª UI â€¢ ${{ matrix.browser }} â€¢ ${{ matrix.env }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        env: [dev, qa]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::group::Install npm dependencies"
          npm ci
          echo "::endgroup::"

      - name: ğŸ­ Install Playwright browsers
        run: |
          echo "::group::Install Playwright browsers & dependencies"
          npx playwright install --with-deps ${{ matrix.browser }}
          echo "::endgroup::"

      - name: â–¶ï¸ Run UI tests
        env:
          NODE_ENV: ${{ matrix.env }}
        run: |
          echo "::group::Running UI test suite"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            npx playwright test --project=${{ matrix.browser }} --grep "@smoke"
          else
            npx playwright test --project=${{ matrix.browser }}
          fi
          echo "::endgroup::"

      - name: â¬†ï¸ Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ” Playwright Report â€¢ ${{ matrix.browser }} â€¢ ${{ matrix.env }}
          path: playwright-report/
          retention-days: 7

  # ğŸ¥’ BDD Cucumber Testing
  bdd-tests:
    name: ğŸ¥’ BDD Cucumber â€¢ ${{ matrix.env }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, qa]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::group::Install npm dependencies"
          npm ci
          echo "::endgroup::"

      - name: ğŸ­ Install Playwright browsers
        run: |
          echo "::group::Install Playwright browsers for BDD tests"
          npx playwright install --with-deps chromium
          echo "::endgroup::"

      - name: â–¶ï¸ Run BDD Cucumber tests
        env:
          NODE_ENV: ${{ matrix.env }}
        run: |
          echo "::group::Running BDD Cucumber test suite"
          npm run bdd
          echo "::endgroup::"

      - name: ğŸ“Š Generate Cucumber report
        if: always()
        run: |
          echo "::group::Generate Cucumber HTML report"
          npm run bdd:report
          echo "::endgroup::"

      - name: â¬†ï¸ Upload Cucumber report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ¥’ Cucumber Report â€¢ ${{ matrix.env }}
          path: reports/
          retention-days: 7

  # ğŸš€ API Testing Suite
  api-tests:
    name: ğŸš€ API â€¢ Senior SDET â€¢ ${{ matrix.env }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [dev, qa]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::group::Install npm dependencies"
          npm ci
          echo "::endgroup::"

      - name: â–¶ï¸ Run API tests with Senior SDET standards
        env:
          NODE_ENV: ${{ matrix.env }}
        run: |
          echo "::group::Running API test suite with Senior SDET standards"
          npm run test:api
          echo "::endgroup::"

      - name: â¬†ï¸ Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ğŸš€ API Test Results â€¢ ${{ matrix.env }}
          path: playwright-report/
          retention-days: 7

  # âš¡ Enhanced Parallelization Tests
  enhanced-tests:
    name: âš¡ Enhanced â€¢ Day 9 â€¢ ${{ matrix.config }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [dev, qa]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "::group::Install npm dependencies"
          npm ci
          echo "::endgroup::"

      - name: ğŸ­ Install Playwright browsers
        run: |
          echo "::group::Install Playwright browsers for enhanced testing"
          npx playwright install --with-deps
          echo "::endgroup::"

      - name: â–¶ï¸ Run enhanced parallelization tests
        env:
          NODE_ENV: ${{ matrix.config }}
        run: |
          echo "::group::Running enhanced test suite with intelligent worker management"
          npm run test:enhanced:${{ matrix.config }}
          echo "::endgroup::"

      - name: â¬†ï¸ Upload enhanced test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: âš¡ Enhanced Test Results â€¢ ${{ matrix.config }}
          path: playwright-report/
          retention-days: 7

  # ğŸ Summary
  summary:
    name: ğŸ CI Summary
    runs-on: ubuntu-latest
    needs: [ui-tests, bdd-tests, api-tests, enhanced-tests]
    if: always()

    steps:
      - name: ğŸ§¾ Generate comprehensive CI summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'UI Tests', status: '${{ needs.ui-tests.result }}', icon: 'ğŸ§ª' },
              { name: 'BDD Cucumber', status: '${{ needs.bdd-tests.result }}', icon: 'ğŸ¥’' },
              { name: 'API Testing', status: '${{ needs.api-tests.result }}', icon: 'ğŸš€' },
              { name: 'Enhanced Parallelization', status: '${{ needs.enhanced-tests.result }}', icon: 'âš¡' }
            ]

            const overallStatus = jobs.every(job => job.status === 'success') ? 'success' : 
                                 jobs.some(job => job.status === 'failure') ? 'failure' : 'mixed'

            const statusIcon = overallStatus === 'success' ? 'âœ…' : overallStatus === 'failure' ? 'âŒ' : 'âš ï¸'
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`

            const tableRows = [
              [{data:'Test Suite', header:true}, {data:'Status', header:true}, {data:'Details', header:true}]
            ]

            jobs.forEach(job => {
              const jobStatusIcon = job.status === 'success' ? 'âœ…' : job.status === 'failure' ? 'âŒ' : 'âš ï¸'
              tableRows.push([
                job.icon + ' ' + job.name,
                jobStatusIcon + ' ' + job.status.toUpperCase(),
                '[View Details](' + runUrl + ')'
              ])
            })

            core.summary
              .addHeading(`ğŸ Day 9 Enterprise Test Framework CI Summary â€“ ${statusIcon} ${overallStatus.toUpperCase()}`)
              .addTable(tableRows)
              .addSeparator()
              .addHeading('ğŸ“Š Test Coverage Overview')
              .addList([
                'ğŸ§ª **UI Testing**: Cross-browser compatibility (Chromium, Firefox, WebKit)',
                'ğŸ¥’ **BDD Cucumber**: Business-driven development with Gherkin scenarios',
                'ğŸš€ **API Testing**: Senior SDET standards with schema validation',
                'âš¡ **Enhanced Parallelization**: Intelligent worker management and test sharding'
              ])
              .addSeparator()
              .addHeading('ğŸ”§ Enterprise Features')
              .addList([
                'ğŸ“Š **Test Data Management**: Role-based users and environment configurations',
                'ğŸ—ï¸ **Advanced Parallelization**: System resource detection and optimal distribution',
                'ğŸ‘¨â€ğŸ’» **Senior SDET Standards**: Production-grade API testing with cleanup',
                'ğŸ“ˆ **Performance Monitoring**: Response time tracking and resource management',
                'ğŸ” **Health Checks**: Service availability and contract validation',
                'ğŸ¯ **Production Ready**: Enterprise-grade error handling and observability'
              ])
              .addQuote('ğŸš€ All artifacts and detailed reports are available in the Actions tab above.')
              .write()
